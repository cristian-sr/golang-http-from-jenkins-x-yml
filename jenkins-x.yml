pipelineConfig:
  agent:
    image: go
    label: jenkins-go
  pipelines:
    pullRequest:
      pipeline:
        agent:
          image: go
        stages:
        - name: run-make
          steps:
          - command: make linux
            name: build-make-linux
        - name: everything-else
          steps:
          - command: export VERSION=$PREVIEW_VERSION && skaffold build -f skaffold.yaml
            name: build-container-build
          - command: jx step post build --image $DOCKER_REGISTRY/$ORG/$APP_NAME:$PREVIEW_VERSION
            name: postbuild-post-build
          - command: make preview
            dir: /workspace/source/charts/preview
            name: promote-make-preview
          - command: jx preview --app $APP_NAME --dir ../..
            dir: /workspace/source/charts/preview
            name: promote-jx-preview
    release:
      pipeline:
        agent:
          image: go
        stages:
        - name: run-make
          steps:
          - command: jx step git credentials
            name: setup-jx-git-credentials
          - command: make build
            name: build-make-build
        - name: everything-else
          steps:
          - command: export VERSION=`cat VERSION` && skaffold build -f skaffold.yaml
            name: build-container-build
          - command: jx step post build --image $DOCKER_REGISTRY/$ORG/$APP_NAME:\$(cat VERSION)
            name: build-post-build
          - command: jx step changelog --version v${VERSION}
            name: promote-changelog
          - command: jx step helm release
            dir: /workspace/source/charts/golang-http-from-jenkins-x-yml
            name: promote-helm-release
          - command: jx promote -b --all-auto --timeout 1h --version \$(cat ../../VERSION)
            dir: /workspace/source/charts/golang-http-from-jenkins-x-yml
            name: promote-jx-promote
